# $Id: Makefile.in,v 1.37 2010-11-08 06:16:41 oops Exp $
srcdir          = @srcdir@
top_srcdir      = @top_srcdir@
builddir        = @builddir@
top_builddir    = .

build           = @build@
build_cpu       = @build_cpu@
build_vendor    = @build_vendor@
build_os        = @build_os@
host            = @host@
host_cpu        = @host_cpu@
host_vendor     = @host_vendor@

PROG            = @PACKAGE_NAME@
VERSION         = @PACKAGE_VERSION@
COMPAT          = @COMPAT_VERSION@
CC              = @CC@ -Wall
CFLAGS          = @CFLAGS@
CPPFLAGS        = -I. @CPPFLAGS@
LIBS            = @LIBS@
LDFLAGS         = @LDFLAGS@ $(LIBS)
DEFS            = @DEFS@ $(CPPFLAGS)
KR_DEFS         = @KR_DEFS@ $(CFLAGS)

OBJECT          = krdb.lo krispapi.lo krisp.lo
UTIL_OBJ        = krisplookup.lo krispmkdb.lo
HEADER_NAME     = krisp-config krispcommon krispapi krisp krdb krversion

SONAME_MAJOR    = @SONAME_MAJOR@
SONAME_MINOR    = @SONAME_MINOR@
SONAME_REVISION = @SONAME_REVISION@
SONAME_INFO     = @SONAME_INFO@
SONAME_VERSION  = @SONAME_VERSION@

prefix          = @prefix@
exec_prefix     = @exec_prefix@
datadir         = @datadir@
includedir      = @includedir@
libdir          = @libdir@
bindir          = @bindir@
mandir          = @mandir@
DESTDIR         =

LIBTOOL         = @LIBTOOL@
INSTALL         = @INSTALL@
RM              = @RM@ -f
#MAKE            = @MAKE@
MKDIR           = @MKDIR@ -p
STRIP           = @STRIP@
LN              = @LN_S@
MV              = @MV@
PERL            = @PERL@
SQLITE			= @SQLITE@

CC_OPT          = $(CC) $(CFLAGS) $(DEFS)
LINK            = $(LIBTOOL) --mode=link $(CC_OPT) -rpath $(libdir) -version-info $(SONAME_INFO)
PLINK           = $(LIBTOOL) --mode=link $(CC_OPT) -rpath $(libdir)
COMPILE         = $(LIBTOOL) --mode=compile $(CC_OPT) $(DEFS) -prefer-pic
P_LIBTOOL       = $(LIBTOOL) --mode=install @INSTALL_PROGRAM@ -m755
D_LIBTOOL       = $(LIBTOOL) --mode=install @INSTALL_DATA@ -m644
L_LIBTOOL       = $(LIBTOOL) --mode=install $(INSTALL)

MAN1            = krisplookup krispmkdb
MAN3            = krisp_version kr_open kr_close kr_search kr_search_ex


all: $(OBJECT) $(UTIL_OBJ)
	$(MAKE) libs
	$(PLINK) -o $(PROG)lookup $(PROG)lookup.lo libkrisp$(COMPAT).la
	$(PLINK) -o $(PROG)mkdb $(PROG)mkdb.lo $(OBJECT) $(LDFLAGS)

krdb.lo: krdb.c database/sqlite.c database/sqlite3.c krdb.h krispcommon.h
	$(COMPILE) -o $@ -c $<

krispapi.lo: krispapi.c krdb.h krispapi.h krispcommon.h
	$(COMPILE) -o $@ -c $<

krisp.lo: krisp.c krdb.h krisp.h krispapi.h krispcommon.h
	$(COMPILE) -o $@ -c $<

krisplookup.lo: krisplookup.c krisp.h krdb.h krispapi.h krispcommon.h
	$(COMPILE) -o $@ -c $<

krispmkdb.lo: krispmkdb.c krispcommon.h krisp.h krdb.h krispapi.h
	$(COMPILE) -o $@ -c $<

libs:
	$(PERL) -pi -e 's!/\*[\s]+(#undef )KR_(PACKAGE_[A-Z]+)[\s]+\*/!	$$1$$2!g' krisp-config.h
	$(LINK) -o lib$(PROG)$(COMPAT).la $(OBJECT) $(LDFLAGS)
	$(PERL) -pi -e 's! /[^ ]*libsqlite.la! -lsqlite!g' .libs/libkrisp$(COMPAT).lai libkrisp$(COMPAT).la
	$(PERL) -pi -e 's! /[^ ]*libsqlite3.la! -lsqlite3!g' .libs/libkrisp$(COMPAT).lai libkrisp$(COMPAT).la

data:
	./krispmkdb -c db/krisp.csv -t krisp -y db/krisp.dat

install: install-header install-data install-man
	$(MKDIR) $(DESTDIR)$(bindir)
	$(MKDIR) $(DESTDIR)$(libdir)/pkgconfig
	$(P_LIBTOOL) $(PROG)-config $(DESTDIR)$(bindir)/$(PROG)$(COMPAT)-config
	$(P_LIBTOOL) $(PROG)lookup $(DESTDIR)$(bindir)/$(PROG)lookup$(COMPAT)
	$(P_LIBTOOL) $(PROG)mkdb $(DESTDIR)$(bindir)/$(PROG)mkdb$(COMPAT)
	$(L_LIBTOOL) lib$(PROG)$(COMPAT).la $(DESTDIR)$(libdir)/lib$(PROG)$(COMPAT).la
	$(L_LIBTOOL) $(PROG).pc $(DESTDIR)$(libdir)/pkgconfig/$(PROG)$(COMPAT).pc
	$(LIBTOOL) --finish $(libdir)

install-data:
	$(MKDIR) $(DESTDIR)$(datadir)/$(PROG)$(COMPAT)
	for i in krisp.dat krisp.csv; do \
		$(D_LIBTOOL) db/$$i $(DESTDIR)$(datadir)/$(PROG)$(COMPAT)/ ; \
	done

install-man:
ifndef COMPAT
	$(MKDIR) $(DESTDIR)$(mandir)/ko/man1
	$(MKDIR) $(DESTDIR)$(mandir)/ko/man3
	for i in $(MAN1); do \
		$(D_LIBTOOL) man/$$i.1 $(DESTDIR)$(mandir)/ko/man1/ ; \
	done
	for i in $(MAN3); do \
		$(D_LIBTOOL) man/$$i.3 $(DESTDIR)$(mandir)/ko/man3/ ; \
	done
endif

install-header:
	$(MKDIR) $(DESTDIR)$(includedir)/krisp$(COMPAT)
	for i in $(HEADER_NAME); do \
		$(D_LIBTOOL) $$i.h $(DESTDIR)$(includedir)/krisp$(COMPAT)/ ; \
	done

test: all
	make -C test

clean:
	-$(RM) -r *.o *.lo* *.la* $(PROG)lookup $(PROG)mkdb
	-$(RM) -r .libs db/$(PROG).dat
	make -C test clean

distclean: clean
	for i in `ls *.in`; \
	do \
		rmfiles=`echo $$i | sed 's/\.in$$//g'`; \
		$(RM) -r $$rmfiles; \
	done
	-$(RM) -r krispcommon.h krdb.h $(PROG)-config
	-$(RM) -r libtool config.log config.status
	-$(RM) -r $(PROG)-config.h *~ test/Makefile
